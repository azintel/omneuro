<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Customer Garage | Juice Junkiez</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    /* tiny additions specific to scheduling */
    .inline{display:flex;gap:8px;flex-wrap:wrap}
    .slot{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#0f0f0f}
    .slot b{font-size:14px}
    .slot small{color:var(--muted)}
    .slots{display:grid;gap:8px}
    .muted{color:var(--muted)}
    .btn{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0f0f0f;color:inherit;cursor:pointer}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,216,77,.15)}
    .success{color:#64d98b}
    .error{color:#ff7a7a}
    header.wrap .login{margin-left:auto}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Customer Garage</h1>
    <p class="muted">Add a vehicle, and book service with our live scheduler.</p>
    <a href="/garage/login.html" class="login btn">Login</a>
  </header>

  <main class="wrap grid">
    <!-- Add Vehicle -->
    <section class="card">
      <h2>Add Vehicle</h2>
      <form id="addForm">
        <label>Email <input type="email" name="owner_email" required placeholder="you@example.com" /></label>
        <div class="inline" style="gap:12px;align-items:center">
          <label>Make <input type="text" name="make" required placeholder="Begode" /></label>
          <label>Model <input type="text" name="model" required placeholder="Master" /></label>
        </div>
        <label>Nickname <input type="text" name="nickname" placeholder="(optional)" /></label>
        <label>Notes <textarea name="notes" rows="3" placeholder="(optional)"></textarea></label>
        <button type="submit" class="btn">Save Vehicle</button>
      </form>
      <div id="addMsg" class="msg" aria-live="polite"></div>
    </section>

    <!-- List Vehicles -->
    <section class="card">
      <h2>My Vehicles</h2>
      <form id="listForm" class="inline">
        <input type="email" name="owner_email" required placeholder="you@example.com" />
        <button type="submit" class="btn">Load</button>
      </form>
      <div id="listMsg" class="msg muted" aria-live="polite"></div>
      <ul id="vehicleList" class="list"></ul>
    </section>

    <!-- Schedule Appointment -->
    <section class="card" style="grid-column:1/-1">
      <h2>Schedule Service</h2>
      <p class="muted">Search free slots and book instantly. We’ll confirm by email/SMS.</p>
      <form id="slotForm" class="inline">
        <input type="email" name="owner_email" required placeholder="you@example.com" />
        <input type="date" name="start" required />
        <input type="date" name="end" required />
        <button type="submit" class="btn">Find Slots</button>
      </form>
      <div id="slotMsg" class="msg muted" aria-live="polite"></div>
      <div id="slotList" class="slots"></div>
    </section>
  </main>

  <footer class="wrap muted">
    © <span id="y"></span> Juice Junkiez • Powered by Omneuro
  </footer>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();
    const API = "/api";

    const $ = (sel, root=document)=>root.querySelector(sel);
    const el = (tag, attrs={})=>{
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==="text") n.textContent=v;
        else if(k==="html") n.innerHTML=v;
        else n.setAttribute(k,v);
      });
      return n;
    };

    async function postJSON(url, body){
      const r = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function getJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    // Add vehicle
    $("#addForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      $("#addMsg").textContent = "";
      const fd = new FormData(e.currentTarget);
      const payload = Object.fromEntries(fd.entries());
      try{
        const out = await postJSON(API + "/garage/vehicles", payload);
        $("#addMsg").textContent = "Added vehicle ID " + out.vehicle.id;
        $("#addMsg").className = "msg success";
      }catch(err){
        $("#addMsg").textContent = "Error: " + err;
        $("#addMsg").className = "msg error";
      }
    });

    // List vehicles
    $("#listForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      $("#listMsg").textContent = "";
      const fd = new FormData(e.currentTarget);
      const email = fd.get("owner_email");
      try{
        const out = await getJSON(API + "/garage/vehicles?owner_email=" + encodeURIComponent(email));
        const ul = $("#vehicleList");
        ul.innerHTML = "";
        out.items.forEach(v=>{
          const li = el("li"); li.className="list-item";
          li.innerHTML = `<b>${v.make} ${v.model}</b> <small>#${v.id}</small><br /><span class="muted">${v.nickname||""}</span>`;
          ul.appendChild(li);
        });
        $("#listMsg").textContent = out.items.length ? "" : "No vehicles yet.";
      }catch(err){
        $("#listMsg").textContent = "Error: " + err;
      }
    });

    // Find slots
    $("#slotForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      $("#slotMsg").textContent = "";
      $("#slotList").innerHTML = "";
      const fd = new FormData(e.currentTarget);
      const email = fd.get("owner_email");
      const start = fd.get("start");
      const end   = fd.get("end");
      try{
        const out = await getJSON(API + `/scheduler/slots?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
        if(!out.items.length){
          $("#slotMsg").textContent = "No free slots in the selected range.";
          return;
        }
        const list = $("#slotList");
        out.items.slice(0,50).forEach(s=>{
          const row = el("div"); row.className="slot";
          row.innerHTML = `<div><b>${s.date_ymd} ${s.start_hhmm}–${s.end_hhmm}</b><br/><small>${s.tech_name||"Any tech"} • ${s.used}/${s.capacity}</small></div>`;
          const btn = el("button",{class:"btn",text:"Book"});
          btn.onclick = async ()=>{
            $("#slotMsg").textContent = "Booking…";
            try{
              const pay = {
                owner_email: email,
                tech_id: s.tech_id || null,
                date_ymd: s.date_ymd,
                start_minute: s.start_minute,
                end_minute: s.end_minute
              };
              const res = await postJSON(API + "/scheduler/appointments", pay);
              $("#slotMsg").textContent = res.ok ? "Appointment requested! We’ll confirm shortly." : (res.error || "Unknown error");
              $("#slotMsg").className = res.ok ? "msg success" : "msg error";
            }catch(err){
              $("#slotMsg").textContent = "Error: " + err;
              $("#slotMsg").className = "msg error";
            }
          };
          row.appendChild(btn);
          list.appendChild(row);
        });
      }catch(err){
        $("#slotMsg").textContent = "Error: " + err;
        $("#slotMsg").className = "msg error";
      }
    });
  </script>
</body>
</html>